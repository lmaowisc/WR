<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Stratified proportional win-fractions (PW) regression of composite endpoints of death and nonfatal event • WR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Stratified proportional win-fractions (PW) regression of composite endpoints of death and nonfatal event">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/PW_reg.html">Proportional win-fractions (PW) regression of composite endpoints of death and nonfatal event</a></li>
    <li><a class="dropdown-item" href="../articles/PW_stratify_reg.html">Stratified proportional win-fractions (PW) regression of composite endpoints of death and nonfatal event</a></li>
    <li><a class="dropdown-item" href="../articles/WR_sample_size.html">Sample size calculation for standard win ratio test</a></li>
    <li><a class="dropdown-item" href="../articles/WR_test_rec.html">Two-sample win ratio tests of possibly recurrent event and death</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Stratified proportional win-fractions (PW) regression of composite endpoints of death and nonfatal event</h1>
                        <h4 data-toc-skip class="author">Tuo Wang &amp;
Lu Mao (<a href="mailto:lmao@biostat.wisc.edu" class="email">lmao@biostat.wisc.edu</a>)</h4>
            
      

      <div class="d-none name"><code>PW_stratify_reg.Rmd</code></div>
    </div>

    
    
<p>This vignette demonstrates the use of the <code>WR</code> package in
fitting the stratified proportional win-fractions (PW) regression model
for prioritized composite endpoints consisting of death and a nonfatal
event (Wang and Mao, 2022). This is an extension of the unstratified PW
model of Mao and Wang (2020, <em>Biometrics</em>).</p>
<div class="section level2">
<h2 id="model-inference">MODEL &amp; INFERENCE<a class="anchor" aria-label="anchor" href="#model-inference"></a>
</h2>
<div class="section level3">
<h3 id="outcome-data-and-modeling-target">Outcome data and modeling target<a class="anchor" aria-label="anchor" href="#outcome-data-and-modeling-target"></a>
</h3>
<p>Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
denote the survival time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
time to the first nonfatal event like hospitalization, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\boldsymbol Z</annotation></semantics></math>
a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-vector
of covariates. The composite outcome is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐘</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>D</mi><mo>,</mo><mi>T</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol Y=(D, T)</annotation></semantics></math>,
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
prioritized over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>.
Suppose that there are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
strata defined by, e.g., patient demographics or study center. In the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>th
stratum
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(l=1,\ldots, L)</annotation></semantics></math>,
if we want to compare the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>th
patients, denoted respectively using subscripts
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">li</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">lj</annotation></semantics></math>,
we can use Pocock et al.’s (2012) sequential rule with the “win
indicator” defined by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝒲</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝐘</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>,</mo><msub><mi>𝐘</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mtext mathvariant="normal">subject </mtext><mspace width="0.333em"></mspace></mrow><mi>i</mi><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> wins against subject </mtext><mspace width="0.333em"></mspace></mrow><mi>j</mi><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> by </mtext><mspace width="0.333em"></mspace></mrow><mi>t</mi><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> in stratum </mtext><mspace width="0.333em"></mspace></mrow><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo>&lt;</mo><msub><mi>D</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>∧</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>D</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>∧</mo><msub><mi>D</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo>&gt;</mo><mi>t</mi><mo>,</mo><msub><mi>T</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo>&lt;</mo><msub><mi>T</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>∧</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\mathcal W(\boldsymbol Y_{li}, \boldsymbol Y_{lj})(t) 
&amp; = I(\mbox{subject $i$ wins against subject $j$ by $t$ in stratum $l$})\\ 
&amp; = I(D_{lj} &lt; D_{li} \wedge t) + I(D_{li} \wedge D_{lj} &gt; t, T_{lj} &lt; T_{li} \wedge t),
\end{align*}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>∧</mo><mi>b</mi><mo>=</mo><mo>min</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">a\wedge b=\min(a,b)</annotation></semantics></math>.
Then, the (time-dependent) covariate-specific win ratio in the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>th
stratum is
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ℛ</mi><mi>l</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>;</mo><msub><mi>𝐙</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>,</mo><msub><mi>𝐙</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><mfrac><mrow><mi>E</mi><mo stretchy="false" form="prefix">{</mo><mi>𝒲</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝐘</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>,</mo><msub><mi>𝐘</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∣</mo><msub><mi>𝐙</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>,</mo><msub><mi>𝐙</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo stretchy="false" form="postfix">}</mo></mrow><mrow><mi>E</mi><mo stretchy="false" form="prefix">{</mo><mi>𝒲</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝐘</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo>,</mo><msub><mi>𝐘</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>∣</mo><msub><mi>𝐙</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>,</mo><msub><mi>𝐙</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo stretchy="false" form="postfix">}</mo></mrow></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex">\mathcal R_l(t;\boldsymbol Z_{li}, \boldsymbol Z_{lj}):=
\frac{E\{\mathcal W(\boldsymbol Y_{li}, \boldsymbol Y_{lj})(t)\mid \boldsymbol Z_{li}, \boldsymbol Z_{lj}\}}{E\{\mathcal W(\boldsymbol Y_{lj}, \boldsymbol Y_{li})(t)\mid \boldsymbol Z_{li}, \boldsymbol Z_{lj}\}}.</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="model-specification">Model specification<a class="anchor" aria-label="anchor" href="#model-specification"></a>
</h3>
<p>The stratified PW model specifies that <span class="math display">$$\begin{equation}\tag{1}
\mbox{Stratified PW:}\hspace{3mm} \mathcal R_l(t;\boldsymbol Z_{li},
\boldsymbol Z_{lj})=\exp\{\boldsymbol\beta^{\rm T}(\boldsymbol Z_{li}
-\boldsymbol Z_{lj})\},\hspace{3mm} l=1,\ldots, L.
\end{equation}$$</span> That is, we assume that the covariate-specific
win ratio in each stratum is invariant to the follow-up time
(proportionality of the win fractions) and depends on a common
regression parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\boldsymbol\beta</annotation></semantics></math>.
Under model (1), the components of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\boldsymbol\beta</annotation></semantics></math>
can be interpreted as the log-win ratios associated with unit increases
in the corresponding covariates <em>within each stratum</em>. Because
model (1) involves only within-stratum comparisons, it does not require
proportionality to hold across strata as an unstratified PW model
does.</p>
</div>
<div class="section level3">
<h3 id="number-of-strata-and-inference-procedure">Number of strata and inference procedure<a class="anchor" aria-label="anchor" href="#number-of-strata-and-inference-procedure"></a>
</h3>
<p>Under (1), we can obtain consistent estimates for the parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\boldsymbol\beta</annotation></semantics></math>
based on censored data under the independent censoring assumption
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>C</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo>⊥</mo><msub><mi>𝐘</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>∣</mo><msub><mi>𝐙</mi><mrow><mi>l</mi><mi>i</mi></mrow></msub><mi>.</mi></mrow><annotation encoding="application/x-tex">(C_{li}\perp \boldsymbol Y_{li})\mid \boldsymbol Z_{li}.</annotation></semantics></math>
for every
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">l=1,\ldots, L</annotation></semantics></math>.
There are two approaches to estimating the variance of the resulting
estimator
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\boldsymbol\beta</annotation></semantics></math>,
each appropriate in a different context. When the number of strata
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
is small, such as in the case of sex or race categories, we can apply
the variance estimator of the unstratified PW model to each stratum and
sum up the stratum-specific variances. We call this the <strong>type
I</strong> variance estimator. When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
is large, such as in the case of matched pairs (so that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mi>n</mi><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">L=n/2</annotation></semantics></math>),
each stratum need not contain enough subjects to support its own
variance estimator. We instead treat the strata as basic units of
observation and take a Lindeberg–Feller-type approach to quantifying the
variance of the sum of the independent (but not necessarily identically
distributed) units. This gives us a <strong>type II</strong> variance
estimator.</p>
</div>
</div>
<div class="section level2">
<h2 id="basic-syntax">BASIC SYNTAX<a class="anchor" aria-label="anchor" href="#basic-syntax"></a>
</h2>
<p>The input data must be in the “long format”, with an <code>ID</code>
vector containing unique patient-level identifiers. In addition, we need
a <code>time</code> vector containing the event times and a
<code>status</code> vector indicating the corresponding cause of the
event. The vector <code>status</code> should be coded as
<code>1</code>=death; <code>2</code>=non-fatal event;
<code>0</code>=censoring. In the case of recurrent non-fatal events,
multiple rows with <code>status</code>=2 are allowed. However, by nature
of the method, only time to the first episode will be used. Finally, we
need a covariate matrix <code>Z</code> with the same row as
<code>ID</code>. Each column of <code>Z</code> represents a covariate.
All covariates need to be time-constant.</p>
<p>The main function to fit the stratified PW model is</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/pwreg.html">pwreg</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">time</span>, <span class="va">status</span>, <span class="va">Z</span>, <span class="va">strata</span>, fixedL<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> </span></code></pre></div>
<p>with <code>ID</code>, <code>time</code>, <code>status</code>, and
<code>Z</code> as specified above. The optional argument
<code>strata</code> accepts the (categorical) stratifying variable. The
default option <code>fixedL=TRUE</code> requests the type I variance
estimator (under small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>)
while <code>fixedL=FALSE</code> requests the type II variance estimator
(under large
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>).
The function returns an object of class <code>pwreg</code> with a
<code>beta</code> vector for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{\boldsymbol\beta}</annotation></semantics></math>
and a <code>Var</code> matrix for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">var</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{var}(\widehat{\boldsymbol\beta})</annotation></semantics></math>.
Score processes to check the proportionality assumption can be computed
and plotted by</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## compute the standardized score processes</span></span>
<span><span class="va">score</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/score.proc.html">score.proc</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="co">## plot the computed process for the kth covariate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">score</span>, <span class="va">k</span><span class="op">)</span></span></code></pre></div>
<p>As a rule of thumb, we consider the proportionality to be tenable if
the score processes are bounded in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mn>2</mn><mo>,</mo><mn>2</mn><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[-2, 2]</annotation></semantics></math>.</p>
</div>
<div class="section level2">
<h2 id="an-example-with-the-german-breast-cancer-study">AN EXAMPLE WITH THE GERMAN BREAST CANCER STUDY<a class="anchor" aria-label="anchor" href="#an-example-with-the-german-breast-cancer-study"></a>
</h2>
<p>We demonstrate the stratified PW regression methods using a subset of
the data from the German Breast Cancer study consisting of 686 patients
with primary node positive breast cancer (Sauerbrei et al., 1999).</p>
<div class="section level3">
<h3 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<p>The study was conducted between July 1984 to December 1989 to assess
the effectiveness of hormonal treatment with tamoxifen in addition to
standard chemotherapy in reducing the cancer relapse (nonfatal event)
and mortality of patients.</p>
<p>We first load the <code>WR</code> package and the analysis dataset
<code>gbc</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sites.google.com/view/lmaowisc/" class="external-link">WR</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gbc</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id     time status hormone age menopause size grade nodes prog_recp</span></span>
<span><span class="co">#&gt; 1  1 43.83607      2       1  38         1   18     3     5       141</span></span>
<span><span class="co">#&gt; 2  1 74.81967      0       1  38         1   18     3     5       141</span></span>
<span><span class="co">#&gt; 3  2 46.55738      2       1  52         1   20     1     1        78</span></span>
<span><span class="co">#&gt; 4  2 65.77049      0       1  52         1   20     1     1        78</span></span>
<span><span class="co">#&gt; 5  3 41.93443      2       1  47         1   30     2     1       422</span></span>
<span><span class="co">#&gt; 6  3 47.73770      1       1  47         1   30     2     1       422</span></span>
<span><span class="co">#&gt;   estrg_recp</span></span>
<span><span class="co">#&gt; 1        105</span></span>
<span><span class="co">#&gt; 2        105</span></span>
<span><span class="co">#&gt; 3         14</span></span>
<span><span class="co">#&gt; 4         14</span></span>
<span><span class="co">#&gt; 5         89</span></span>
<span><span class="co">#&gt; 6         89</span></span></code></pre></div>
<p>Covariates include:</p>
<ul>
<li>
<code>hormone</code>: Treatment indicator: 1=Hormone therapy;
2=standard therapy;</li>
<li>
<code>age</code> Age at diagnosis (years)</li>
<li>
<code>menopause</code> Menopausal Status; 1=No; 2=Yes</li>
<li>
<code>grade</code> Tumor grade, 1-3</li>
<li>
<code>nodes</code> Number of nodes involved</li>
<li>
<code>prog_recp</code> Number of progesterone receptors</li>
<li>
<code>estrg_recp</code> Number of estrogen receptors</li>
</ul>
<p>The <code>grade</code> column in <code>gbc</code> is a factor
variable. We create dummy variables for <code>grade</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grade_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">grade</span><span class="op">)</span>,data<span class="op">=</span><span class="va">gbc</span><span class="op">)</span></span>
<span><span class="va">grade_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">grade_matrix</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">grade_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grade2 vs grade1"</span>, <span class="st">"grade3 vs grade1"</span><span class="op">)</span></span>
<span><span class="va">gbc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span><span class="va">gbc</span><span class="op">[</span>,<span class="op">-</span><span class="fl">8</span><span class="op">]</span>, <span class="va">grade_df</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="stratification-by-menopause-status">Stratification by menopause status<a class="anchor" aria-label="anchor" href="#stratification-by-menopause-status"></a>
</h3>
<p>Next, we fit a PW model stratified by menopause status. Because the
stratifying variable has only two levels, we use the type I variance
estimator.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## extract the covariate matrix Z from the data</span></span>
<span><span class="co">## leaving out menopause as the stratifying variable</span></span>
<span><span class="va">Z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">gbc</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hormone"</span>, <span class="st">"age"</span>, <span class="st">"size"</span>, <span class="st">"nodes"</span>, <span class="st">"prog_recp"</span>,</span>
<span>                       <span class="st">"estrg_recp"</span>, <span class="st">"grade2 vs grade1"</span>, <span class="st">"grade3 vs grade1"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## fit a PW model stratified by the binary menopause status</span></span>
<span><span class="co">## use type I variance estimator</span></span>
<span><span class="va">obj1</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/pwreg.html">pwreg</a></span><span class="op">(</span>ID<span class="op">=</span><span class="va">gbc</span><span class="op">$</span><span class="va">id</span>,time<span class="op">=</span><span class="va">gbc</span><span class="op">$</span><span class="va">time</span>,status<span class="op">=</span><span class="va">gbc</span><span class="op">$</span><span class="va">status</span>, Z<span class="op">=</span><span class="va">Z1</span>,strata<span class="op">=</span><span class="va">gbc</span><span class="op">$</span><span class="va">menopause</span>,fixedL<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## print out the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">obj1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; pwreg(ID = gbc$id, time = gbc$time, status = gbc$status, Z = Z1, </span></span>
<span><span class="co">#&gt;     strata = gbc$menopause, fixedL = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stratified proportional win-fractions regression analysis</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     (Wang and Mao, 2021+):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total number of strata: 2 </span></span>
<span><span class="co">#&gt; Newton-Raphson algorithm converged in 6 iterations.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall test: chisq test with 8 degrees of freedom; </span></span>
<span><span class="co">#&gt;  Wald statistic 96 with p-value 0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates for Regression parameters:</span></span>
<span><span class="co">#&gt;                     Estimate          se z.value   p.value    </span></span>
<span><span class="co">#&gt; hormone           4.2232e-01  1.4207e-01  2.9726  0.002953 ** </span></span>
<span><span class="co">#&gt; age               1.2849e-02  9.9410e-03  1.2925  0.196175    </span></span>
<span><span class="co">#&gt; size             -1.0653e-02  4.6504e-03 -2.2909  0.021971 *  </span></span>
<span><span class="co">#&gt; nodes            -8.0716e-02  1.5057e-02 -5.3607 8.288e-08 ***</span></span>
<span><span class="co">#&gt; prog_recp         2.4843e-03  6.1486e-04  4.0404 5.337e-05 ***</span></span>
<span><span class="co">#&gt; estrg_recp       -6.8751e-05  5.1367e-04 -0.1338  0.893527    </span></span>
<span><span class="co">#&gt; grade2 vs grade1 -6.5226e-01  2.5633e-01 -2.5447  0.010938 *  </span></span>
<span><span class="co">#&gt; grade3 vs grade1 -8.5797e-01  2.8480e-01 -3.0126  0.002590 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Point and interval estimates for the win ratios:</span></span>
<span><span class="co">#&gt;                  Win Ratio 95% lower CL 95% higher CL</span></span>
<span><span class="co">#&gt; hormone          1.5254939    1.1547326     2.0152991</span></span>
<span><span class="co">#&gt; age              1.0129319    0.9933870     1.0328614</span></span>
<span><span class="co">#&gt; size             0.9894031    0.9804261     0.9984623</span></span>
<span><span class="co">#&gt; nodes            0.9224554    0.8956306     0.9500837</span></span>
<span><span class="co">#&gt; prog_recp        1.0024873    1.0012800     1.0036962</span></span>
<span><span class="co">#&gt; estrg_recp       0.9999313    0.9989250     1.0009385</span></span>
<span><span class="co">#&gt; grade2 vs grade1 0.5208648    0.3151662     0.8608161</span></span>
<span><span class="co">#&gt; grade3 vs grade1 0.4240199    0.2426418     0.7409807</span></span></code></pre></div>
<p>We can see that, adjusting for other variables and stratifying by
menopause status, hormonal treatment makes the patient 1.5 times as
likely to have a more favorable outcome (prioritizing survival over
cancer relapse), with 95% confidence interval (1.2, 2.0) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-value
0.003. Next, plot the standardized score process for each covariate:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">score1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score.proc.html">score.proc</a></span><span class="op">(</span><span class="va">obj1</span><span class="op">)</span></span>
<span><span class="va">oldpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="st">"mfrow"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">score1</span>, k <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col<span class="op">=</span><span class="st">"blue"</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"blue"</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span>  <span class="fl">2</span>, col<span class="op">=</span><span class="st">"blue"</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p><img src="PW_stratify_reg_files/figure-html/unnamed-chunk-6-1.png" width="720">
All curves are bounded between -2 and 2, suggesting no severe violation
of the proportionality assumption.</p>
</div>
<div class="section level3">
<h3 id="stratification-by-age">Stratification by age<a class="anchor" aria-label="anchor" href="#stratification-by-age"></a>
</h3>
<p>As illustration, we fit another PW model stratified by finely-cut age
groups.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## cut age into ~30 groups by quantiles</span></span>
<span><span class="va">cutpoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">gbc</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">gbc</span><span class="op">$</span><span class="va">status</span><span class="op">&lt;</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">1</span>,by<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="va">cutpoints</span></span>
<span><span class="co">#&gt;  [1]  0.0 40.0 41.2 43.0 44.0 45.0 46.0 47.0 48.0 49.0 50.0 51.0 52.0 53.0 54.0</span></span>
<span><span class="co">#&gt; [16] 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0 64.0 65.0 66.0 67.0 69.0 71.0</span></span>
<span><span class="co">#&gt; [31] 80.0  Inf</span></span>
<span><span class="va">age_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">gbc</span><span class="op">$</span><span class="va">age</span>, breaks <span class="op">=</span> <span class="va">cutpoints</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Now that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>&gt;</mo><mn>30</mn></mrow><annotation encoding="application/x-tex">L&gt;30</annotation></semantics></math>,
it would be better to use type II variance estimator for inference.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## extract the covariate matrix Z from the data</span></span>
<span><span class="co">## leaving out age as the stratifying variable</span></span>
<span><span class="va">Z2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">gbc</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hormone"</span>, <span class="st">"menopause"</span>, <span class="st">"size"</span>, <span class="st">"nodes"</span>, <span class="st">"prog_recp"</span>,</span>
<span>                       <span class="st">"estrg_recp"</span>, <span class="st">"grade2 vs grade1"</span>, <span class="st">"grade3 vs grade1"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## fit a PW model stratified by the binary menopause status</span></span>
<span><span class="co">## use type II variance estimator because L is large</span></span>
<span><span class="va">obj2</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/pwreg.html">pwreg</a></span><span class="op">(</span>ID<span class="op">=</span><span class="va">gbc</span><span class="op">$</span><span class="va">id</span>,time<span class="op">=</span><span class="va">gbc</span><span class="op">$</span><span class="va">time</span>,status<span class="op">=</span><span class="va">gbc</span><span class="op">$</span><span class="va">status</span>, Z<span class="op">=</span><span class="va">Z2</span>,strata<span class="op">=</span><span class="va">age_group</span>,fixedL<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## print out the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">obj2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; pwreg(ID = gbc$id, time = gbc$time, status = gbc$status, Z = Z2, </span></span>
<span><span class="co">#&gt;     strata = age_group, fixedL = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stratified proportional win-fractions regression analysis</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     (Wang and Mao, 2021+):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total number of strata: 31 </span></span>
<span><span class="co">#&gt; Newton-Raphson algorithm converged in 6 iterations.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall test: chisq test with 8 degrees of freedom; </span></span>
<span><span class="co">#&gt;  Wald statistic 75.4 with p-value 4.168887e-13 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates for Regression parameters:</span></span>
<span><span class="co">#&gt;                     Estimate          se z.value   p.value    </span></span>
<span><span class="co">#&gt; hormone           4.8641e-01  1.5611e-01  3.1158 0.0018346 ** </span></span>
<span><span class="co">#&gt; menopause        -2.1619e-02  2.7309e-01 -0.0792 0.9369026    </span></span>
<span><span class="co">#&gt; size             -1.1571e-02  5.0177e-03 -2.3060 0.0211088 *  </span></span>
<span><span class="co">#&gt; nodes            -7.5957e-02  1.7082e-02 -4.4466 8.724e-06 ***</span></span>
<span><span class="co">#&gt; prog_recp         2.3739e-03  6.4165e-04  3.6996 0.0002159 ***</span></span>
<span><span class="co">#&gt; estrg_recp       -6.9157e-05  6.0552e-04 -0.1142 0.9090710    </span></span>
<span><span class="co">#&gt; grade2 vs grade1 -6.3031e-01  2.9273e-01 -2.1532 0.0313009 *  </span></span>
<span><span class="co">#&gt; grade3 vs grade1 -8.0426e-01  3.2323e-01 -2.4882 0.0128400 *  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Point and interval estimates for the win ratios:</span></span>
<span><span class="co">#&gt;                  Win Ratio 95% lower CL 95% higher CL</span></span>
<span><span class="co">#&gt; hormone          1.6264589    1.1977373     2.2086384</span></span>
<span><span class="co">#&gt; menopause        0.9786135    0.5730061     1.6713335</span></span>
<span><span class="co">#&gt; size             0.9884957    0.9788219     0.9982650</span></span>
<span><span class="co">#&gt; nodes            0.9268558    0.8963381     0.9584125</span></span>
<span><span class="co">#&gt; prog_recp        1.0023767    1.0011169     1.0036381</span></span>
<span><span class="co">#&gt; estrg_recp       0.9999308    0.9987448     1.0011183</span></span>
<span><span class="co">#&gt; grade2 vs grade1 0.5324247    0.2999756     0.9449969</span></span>
<span><span class="co">#&gt; grade3 vs grade1 0.4474189    0.2374532     0.8430446</span></span></code></pre></div>
<p>We can see that the results are similar to those of the
menopause-stratified analysis. One can also check the proportionality
assumption in a similar way using the <code><a href="../reference/score.proc.html">score.proc()</a></code>
function.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><p>Mao, L. and Wang, T. (2020). A class of proportional
win-fractions regression models for composite outcomes.
<em>Biometrics</em>, <a href="https://doi.org/10.1111/biom.13382" class="external-link uri">https://doi.org/10.1111/biom.13382</a>.</p></li>
<li><p>Pocock, S., Ariti, C., Collier, T., and Wang, D. (2012). The win
ratio: a new approach to the analysis of composite endpoints in clinical
trials based on clinical priorities. <em>European Heart Journal</em>,
33, 176–182.</p></li>
<li><p>Sauerbrei, W., Royston, P., Bojar, H., Schmoor, C., &amp;
Schumacher, M. (1999). Modelling the effects of standard prognostic
factors in node-positive breast cancer. German Breast Cancer Study Group
(GBSG). <em>British Journal of Cancer</em>, 79, 1752–1760.</p></li>
<li><p>Wang, T. and Mao, L. (2022). Stratified Proportional
Win-fractions Regression Analysis.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lu Mao.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
